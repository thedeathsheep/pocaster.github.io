---
layout: post
title: 摸一摸“状态机”和“行为树”
cover-img: /assets/img/0024502482_0.jpg
thumbnail-img: /assets/img/0024502482_0.jpg
share-img: /assets/img/0024502482_0.jpg
tags: [Technical, Gamedev, Public]
author: pocaster
---  
### 状态机与行为树：游戏开发中的两大行为控制工具

在游戏开发中，AI（人工智能）的行为控制是构建沉浸式玩家体验的关键。为了实现复杂的角色行为，开发者通常依赖于两种主要技术：**状态机（Finite State Machine, FSM）**和**行为树（Behavior Tree, BT）**。这两种工具各有其独特的优势和适用场景，理解它们的核心概念和差异对于设计高效的游戏AI至关重要。

---

### 一、状态机（Finite State Machine, FSM）

#### 1. 核心概念
状态机是一种用于管理对象行为的有向图模型。它由一组**状态（States）**和**转换条件（Transitions）**组成。一个对象在某一时刻只能处于一个状态，并根据特定的条件在不同的状态之间切换。

- **状态（State）**：表示对象当前的行为模式（如“待机”、“攻击”、“逃跑”）。
- **转换条件（Transition）**：决定对象何时从一种状态切换到另一种状态（如“玩家进入视野”触发“攻击”状态）。
- **事件（Event）**：触发状态转换的外部输入（如玩家靠近、受到伤害）。
- **动作（Action）**：在特定状态下执行的行为（如播放动画、释放技能）。

#### 2. 特征描述
- **简单直观**：状态机的结构易于理解，尤其适合描述线性或有限的行为模式。
- **层级化扩展**：可以通过嵌套状态机实现更复杂的行为（如“战斗”状态机包含“攻击”、“防御”等子状态）。
- **局限性**：随着行为复杂度的增加，状态机的管理和维护可能变得繁琐，状态爆炸问题（State Explosion）会影响开发效率。
- **适用场景**：适合行为模式明确且有限的对象，如敌人AI、角色动画状态控制等。

#### 3. 用例
- **敌人AI**：
  - 状态：待机、巡逻、追击、攻击、逃跑。
  - 转换条件：玩家进入视野 → 追击；玩家逃离范围 → 返回巡逻；生命值过低 → 逃跑。
- **角色动画**：
  - 状态：站立、行走、跑动、跳跃、攻击。
  - 转换条件：按下移动键 → 行走；按下跳跃键 → 跳跃。

---

### 二、行为树（Behavior Tree, BT）

#### 1. 核心概念
行为树是一种基于树状结构的决策模型，由**节点（Nodes）**组成，节点分为以下几种类型：
- **组合节点（Composite Nodes）**：决定子节点的执行顺序（如序列节点、选择节点、并行节点）。
- **装饰节点（Decorator Nodes）**：修饰子节点的行为（如条件检查、循环执行）。
- **叶节点（Leaf Nodes）**：执行具体行为（如移动、攻击、等待）。

行为树的执行从根节点开始，按照节点的逻辑逐层展开，直到完成特定任务。

#### 2. 特征描述
- **模块化设计**：节点可以独立开发并重复使用，便于构建复杂的AI行为。
- **灵活性高**：通过组合节点和装饰节点，可以轻松调整行为的优先级和逻辑。
- **可维护性强**：树状结构清晰，便于调试和扩展。
- **适用场景**：适合需要复杂决策逻辑的对象，如BOSS战AI、策略类游戏中的单位行为等。

#### 3. 用例
- **BOSS战AI**：
  - 根节点：选择攻击模式或逃跑。
    - 选择节点1：生命值低于30% → 逃跑。
    - 选择节点2：生命值高于30% → 攻击。
      - 序列节点：使用技能A → 使用技能B → 等待冷却。
- **策略游戏单位**：
  - 根节点：分配任务。
    - 并行节点：移动至目标点，同时检查敌方单位。
      - 序列节点：发现敌人 → 攻击。

---

### 三、状态机与行为树的对比

| 特性              | 状态机（FSM）               | 行为树（BT）                |
|--------------------|----------------------------|----------------------------|
| **复杂度**         | 适合简单或中等复杂度的行为 | 适合高复杂度的行为         |
| **扩展性**         | 有限，层级化扩展较为麻烦   | 强，节点组合灵活           |
| **维护性**         | 易理解，但不易维护         | 树状结构清晰，易于维护     |
| **适用场景**       | 线性行为、动画状态控制     | 复杂决策、策略类游戏       |
| **开发成本**       | 低                         | 较高                       |
| **执行效率**       | 高                         | 中（取决于树的复杂度）     |

---

### 四、选择状态机还是行为树？

- **选择状态机**：
  - 当AI行为相对简单且不需要频繁调整时。
  - 当需要快速实现原型时。
  - 当需要高效管理动画状态时。

- **选择行为树**：
  - 当AI需要复杂的决策逻辑时。
  - 当需要灵活调整优先级或行为组合时。
  - 当AI行为需要频繁扩展或修改时。

---

### 五、实际案例

#### 1. 《超级马里奥》中的敌人AI
- **状态机**：敌人行为简单，如“移动”和“攻击”，适合使用状态机管理。

#### 2. 《黑暗之魂》中的BOSS战AI
- **行为树**：BOSS需要根据玩家的行为动态调整攻击模式，行为树提供了更高的灵活性。

---

### 六、总结

状态机和行为树是游戏开发中两种强大的AI行为控制工具，各有其独特的优势和适用场景。状态机以其简单直观的特性适合处理线性行为，而行为树则以其灵活性和模块化设计成为复杂AI行为的首选。开发者应根据具体需求选择合适的工具，或结合两者以实现更高效的游戏设计。